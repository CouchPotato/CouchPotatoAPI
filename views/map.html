<!doctype html>
<html>
	<head>
		<title>Map of CouchPotatoes</title>
		<meta name="viewport" content="initial-scale=1, user-scalable=no">
		<style type="text/css">
			html, body {
				color: #666;
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
			#map {
				width: 100%;
				height: 100%;
				background: #001e3c;
			}
		</style>
		<script src="/javascript/jquery-1.8.2.js"></script>
		<script src="/javascript/socket.io.min.js"></script>
		<script src="/javascript/tile5.min.js"></script>
		<script src="/javascript/parser.geojson.js"></script>
		<script src="/javascript/world.js"></script>
		<script>
			var map_data = {{map_data}};

			T5.Style.define({

			    'area.simple': {
			       lineWidth: 0.2,
			       stroke: '#000000',
			       fill: '#03406f'
			    }

			});


			$(function() {

				var parser = new T5.GeoJSONParser({ generalizer: GeoJS.generalize }),
					hslaFormatter = T5.formatter('hsla({0}, {1}%, {2}%, {3})');

				function createGlowMarker(size, stopFn) {
					var marker = document.createElement('canvas');
					stopPoints = [0, 0.1, 1];

					marker.width = marker.height = size;

					var context = marker.getContext('2d'),
						halfSize = size / 2,
						radGrad = context.createRadialGradient(halfSize, halfSize, 0, halfSize, halfSize, halfSize);

					for(var ii = 0; ii < stopPoints.length; ii++) {
						var stopVal = stopPoints[ii],
							alpha = 0.4 - (0.4 * Math.sqrt(stopVal));

						radGrad.addColorStop(stopVal, stopFn(stopVal, alpha));
					}

					context.beginPath();
					context.arc(halfSize, halfSize, halfSize, 0, Math.PI * 2, false);
					context.fillStyle = radGrad;
					context.fill();

					return marker;
				}

				function pinStore(store) {
					var storePos = new GeoJS.Pos(store.latitude, store.longitude),
						marker = map.layer('markers').create('marker', {
							xy: new T5.GeoXY(storePos),
							markerType: 'image',
							image: glowMarker,
							size: 3
						});

					marker.scale(10, {
						easing: 'back.out',
						duration: 300,
						complete: function() {
							marker.scale(1, {
								easing: 'sine.out',
								duration: 300
							}, true);
						}
					});
				}

				var glowMarker = createGlowMarker(8, function(stopVal, alpha) {
					var hue = ~~(150 + 70 * stopVal), saturation = 80 + ~~((1 - stopVal / 1) * 20), lightness = 50;

					return hslaFormatter(hue, saturation, lightness, alpha);
				});

				map = new T5.Map('map', {
					'renderer': 'canvas',
					'controls': false,
					'zoombar': {}
				});

				map.center('32 8').zoom(3);


    			var world_layer = map.layer('world', 'draw', {
    				maxZoom: 1
    			});

			    parser.bind('poly', function(evt, data) {
			        var item = world_layer.create('poly', data);
			        item.style = 'area.simple';
			    });

			    parser.run(worldData);

				var socket = io.connect();

				// Listen for get-feelings event.
				socket.on('location', function(lat_long) {
					var split = lat_long.split(',');

					pinStore({
						'latitude': parseFloat(split[0]),
						'longitude': parseFloat(split[1])
					});

				});

			});

		</script>
	</head>
	<body>
		<div id="map"></div>
	</body>
</html>
